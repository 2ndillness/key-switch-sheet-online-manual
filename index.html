<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Key Switch Sheet Online Manual</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
</head>
<body>
  <header>
    <h1>Key Switch Sheet Online Manual</h1>
  </header>

  <div class="container">
    <!-- #region Navigation -->
    <nav><!-- ************************************************************************************************  -->
      <ul>
        <li><a href="#introduction">Key Switch Sheet とは</a></li>
        <li><a href="#setup">導入方法</a></li>
        <li><a href="#sheets">シートの構成</a>
          <ul>
            <li><a href="#sheet-main">Main シート</a></li>
            <li><a href="#sheet-groups">Groups シート</a></li>
            <li><a href="#sheet-settings">Settings シート</a></li>
          </ul>
        </li>
        <li><a href="#menus">メニュー機能</a>
          <ul>
            <li><a href="#menu-project">プロジェクト</a></li>
            <li><a href="#menu-export">エクスポート</a></li>
            <li><a href="#menu-tools">Appツール</a></li>
            <li><a href="#menu-help">Appヘルプ</a></li>
          </ul>
        </li>
        <li><a href="#sidebar">サイドバー機能</a>
          <ul>
            <li><a href="#sidebar-color">カラー選択</a></li>
            <li><a href="#sidebar-group">グループ選択</a></li>
            <li><a href="#sidebar-action">アクション</a></li>
          </ul>
        </li>
        <li><a href="#gemini-gem">キースイッチ抽出 Gem</a></li>
        <li><a href="#tips">Tips</a></li>
        <li><a href="#changelog">更新履歴</a></li>
        <li><a href="#legal">免責事項・ライセンス</a></li>
      </ul>
    </nav>
    <!-- #endregion -->

    <main>
      <!-- #region Introduction -->
      <section id="introduction"><!-- ************************************************************************  -->
        <h2>Key Switch Sheet とは</h2>
        <p>
          <code>Key Switch Sheet</code> は、<code>DAW</code>用のキースイッチマップファイルを
          Googleスプレッドシートで手軽に作成するためのツールです。
        </p>
        <img src="img/over-view.png" alt="over-view" class="zoomable">
        <ul>
          <li>
            1つのアーティキュレーションにつき1つのMIDIノートを出力する
            シンプルなキースイッチ設定にのみ対応しています。
          </li>
          <li>
            ベロシティーや<code>MIDI CC</code>やプログラムチェンジには対応していません。
          </li>
          <li>
            シンプルなキースイッチマップファイルの作成や
            たたき台作成用としてご活用ください。
          </li>
          <li>
            <code>Cubase</code>,<code>Studio One</code>形式でのエクスポートについては
            簡易的な対応となっています。ご了承ください。
          </li>
        </ul>
      </section>
      <!-- #endregion -->

      <!-- #region Setup -->
      <section id="setup"><!-- *******************************************************************************  -->
        <h2>導入方法</h2>
        <div class="accordion">
          <strong class="accordion-header">
            導入手順 ( <span class="skyblue">クリックして開閉</span> )
          </strong>
          <div class="accordion-content">
            <ol>
              <li>
                配布リンクをクリックすると「ドキュメントのコピー」画面が表示されます。
                「コピーを作成」ボタンをクリックして、自分のGoogleドライブに保存してください。
              </li>
              <li>
                <strong>初回実行時の承認手順:</strong><br>
                スクリプトを初めて実行する際、Googleによる承認画面が表示されます。<br>
                以下の手順で許可を行ってください。
                <ul>
                  <li>
                    「承認が必要です」というダイアログで「続行」をクリックします。
                    <div class="image-placeholder">[画像: 承認が必要ですダイアログ]</div>
                  </li>
                  <li>
                    アカウントの選択画面で、使用するGoogleアカウントを選択します。
                    <div class="image-placeholder">
                      [画像: アカウント選択画面]
                    </div>
                  </li>
                  <li>
                    「このアプリはGoogleで確認されていません」という警告が表示されます。<br>
                    左下の「詳細」をクリックし、下部に表示される
                    「Key Switch Sheet（安全ではないページ）に移動」をクリックしてください。
                    <div class="image-placeholder">
                      [画像: 警告画面と詳細リンク]
                    </div>
                  </li>
                  <li>
                    アクセス権限の確認画面が表示されます。もし権限の選択（チェックボックス）が表示された場合は、
                    <strong>すべての項目にチェックを入れて</strong>から「許可」をクリックしてください。
                    <div class="image-placeholder">
                      [画像: 権限確認画面（すべてチェック）]
                    </div>
                  </li>
                </ul>
                <p class="indent note small">
                  ※ この警告は、Googleによる検証を受けていない個人作成のスクリプトで表示される
                  標準的なものです。<br>この認証作業は初回のみ必要です。
                  一度すべての権限を許可すれば、次回以降は毎回認証する必要はありません。
                </p>
              </li>
            </ol>
          </div>
        </div><hr>
      </section>
      <!-- #endregion -->

      <!-- #region Sheets -->
      <section id="sheets"><!-- ******************************************************************************  -->
        <h2>シートの構成</h2>
        <p>
          このツールは <code>Main</code>,<code>Groups</code>,<code>Settings</code>の
          3つのシートで構成されています。<br>
          画面左下のタブをクリックてシートを切り替えてください。
        </p>

        <h3 id="sheet-main">Main シート</h3><!-- **************************************************************  -->
        <p>
          キースイッチマップの主要なデータを入力するシートです。<br>
          1行につき1つのアーティキュレーション（奏法）を定義します。<br>
          手動入力やコピー&ペーストで入力可能です。<br>
          データの入力に便利な<sup>※</sup><a href="#gemini-gem">キースイッチ抽出 Gem</a>
          を用意しています。ぜひご活用ください。
        </p>
        <ul>
          <li>
            <strong>Articulation Name:</strong><br><!------------------------------------------------------------->
            アーティキュレーション名（キースイッチ名）を入力します。
          </li>
          <li>
            <strong>MIDI Note:</strong><br><!--------------------------------------------------------------------->
            MIDIノート名を「音名 + 変化記号 + オクターブ数値」の形式で入力します。
            （例: <code>C#-1</code>, <code>F8</code>など）<br>
            <img src="img/midi-note.png" alt="midi-note">
            <div class="quote-style">
              💡 入力確定時に自動判定が行われます。それに応じて文字色が変化します。
              <ul>
                <li><strong>赤 (エラー):</strong><br>
                  絶対的範囲外、またはフォーマット不正な値です。セルにメモが表示されます。
                </li>
                <li>
                  <strong>オレンジ (範囲外):</strong><br>
                  現在の<sup>※</sup><code>Middle C</code>設定では範囲外ですが、
                  設定変更により有効になる可能性がある値です。セルにメモが表示されます。
                </li>
                <li><strong>黒 (正常):</strong><br>
                  現在の<code>Middle C</code>設定において、MIDIノート番号が0〜127の範囲内に収まる値。
                </li>
              </ul>
            </div>
            <a href="#middle-C" class="right">※ Middle C とは</a>
          </li>
          <li>
            <strong>Group Name:</strong><br><!-------------------------------------------------------------------->
            アーティキュレーションが所属する<sup>※</sup>グループを定義します。<br>
            <code>Groups</code>シートに記入されたリストの中からプルダウン選択します。<br>
            <sup>※</sup><a href="#sidebar-group">サイドバー機能</a>を使って一括指定することも可能です。
            <img src="img/group-name.png" alt="group-name">
            そのため、先ずは<code>Groups</code>シートの<code>Group List</code>列にグループを
            記入しリストを作ってください。<br>
            <p class="alert note small">
              ※エクスポート時にグループが未選択だった場合にはグループリストの先頭のグループが適用されます。<br>
              Cubase 形式でのエクスポートではグループは4つまでに制限されています。<br>
              Studio One 形式でのエクスポートではグループは反映されません。<br>
            </p>
          </li>
          <li>
            <strong>Color:</strong> <br><!------------------------------------------------------------------------>
            <code>#rrggbb</code>形式( 6桁の16進数 )のカラーコードを入力します。<br>
            <img src="img/color-code.png" alt="color-code">
            <div class="quote-style">
              <p class="note">
                💡 <sup>※</sup><a href="#sidebar">サイドバー</a>の<strong>カラーピッカー</strong>や
                <strong>プリセット</strong>からも入力可能です。<br>
                不正な値の場合は文字色が赤になり、メモが表示されます。
              </p>
              <p class="note small">
                ※エクスポート時に未記入もしくは不正な値だった場合にはデフォルト値が採用されます。<br>
                <code>Cubase</code>向けに作成する場合は、プリセットカラーの使用を推奨します。
                <sup>※</sup><a href="#cubase-color">カラー設定の注意</a>
              </p>
            </div>
          </li>
          <li>
            <strong>Color Preview:</strong><br><!----------------------------------------------------------------->
            <code>Color</code>列の値に応じてセルの背景色が設定されます。
          </li>
        </ul>

        <h3 id="sheet-groups">Groups シート</h3><!-- ******************************************************  -->
        <p>
          <code>Main</code>シートの<code>Group Name</code>列で使用する選択肢を管理します。
          ここで定義したグループ名が<code>Main</code>シートのプルダウンリストに表示されます。
        </p>

        <h3 id="sheet-settings">Settings シート</h3><!-- **************************************************  -->
        <p><code>Map Name</code>と<code>Middle C</code>を設定します。</p>
        <img src="img/settings-sheet.png" alt="settings-sheet">
        <ul>
          <li>
            <strong>Map Name:</strong><br>
            <code>DAW</code>内で使用されるマップの名前です。任意の名前を付けることができます。
          </li>
          <li>
            <strong>Middle C:</strong><br>
            音源側の<sup>※</sup><code>Middle C</code>の設定に合わせます。
            <code>3, 4, 5</code>の値からプルダウンで選択します。
            <a href="#middle-C" class="right">※ Middle C とは</a>
          </li>
        </ul>
        <h4 id="mapping-viewer">Mapping Viewer:</h4><!------------------------------------------------------------>
        <p>
          <code>Settings</code>シートには、<code>DAW</code>のピアノロールに見立てた
          キースイッチマッピング確認用の表<br>
          <code>Mapping Viewer</code>が用意されています。
        </p>
        <div class="tall-crop">
          <img src="img/mapping-viewer.png" alt="mapping-viewer" class="zoomable">
        </div>
        <ul>
          <li>表にはMIDIノート名とMIDIノートナンバーを表示しています。</li>
          <li>MIDIノートナンバーは<code>Middle C = 60</code>で固定されています。</li>
          <li>
            MIDIノート名は、設定した<code>Middle C</code>の値によって表示（鍵盤上の位置）が変動します。
          </li>
          <li>
            メニューから「🎹→🗺️　マッピングを表示」を実行すると、<code>Main</code>シートに入力した
            アーティキュレーションのマッピング分布をプレビュー・更新できます。
          </li>
        </ul>
      </section>
      <!-- #endregion -->

      <!-- #region Menus -->
      <section id="menus"><!--  ******************************************************************************  -->
        <h2>メニュー機能</h2>
        <p>スプレッドシート上部のメニューから実行できる機能の詳細です。</p>

        <h3 id="menu-project">💼 プロジェクト</h3><!--  ******************************************************  -->
        <dl class="indent">
          <dt><strong>💾　プロジェクトを保存...</strong></dt>
          <dd>現在のシートの内容を<code>JSON</code>形式のファイルとして
            ローカル（PC）にダウンロードします。<br> バックアップとして機能します。<br>
            <span class="very-small">
              ※シートの編集状態をそのまま保存するため、不正な値や未記入の項目があっても保存可能です。
            </span>
          </dd>
          <dt><strong>📂　プロジェクトを読み込み...</strong></dt>
          <dd>保存された<code>JSON</code>ファイルを読み込み、シートの内容を復元します。</dd>
          <dt><strong>♻️　シートのリセット(新規作成)...</strong></dt>
          <dd>シートの内容をクリアし、新規作成状態にします。</dd>
        </dl>

        <h3 id="menu-export">📤 エクスポート</h3><!--  *******************************************************  -->
        <p>作成したデータを各<code>DAW</code>用の形式で書き出します。
          メニューから出力形式を選択してください。</p>
        <div class="alert">
          <strong>❗ エクスポート時の注意:</strong>
          <ul>
            <li>
              <strong>MIDIノートのエラー:</strong><br>
              不正な値や範囲外の値が存在する場合、エクスポートは実行できません。
              ダイアログにエラー件数が表示されますので、
              <code>Main</code>シートを修正してから再度実行してください。
            </li>
            <li>
              <strong>その他の項目の補正:</strong><br>
              MIDIノート以外の項目に不正な値や未記入がある場合、
              デフォルト値に自動補正されて出力されますのでご注意ください。
            </li>
          </ul>
        </div>
        <h4>対応出力形式:</h4>
        <ul>
          <li><code>.artMap</code>(CakeWalk)</li>
          <li><code>.expressionmap</code>(Cubase)</li>
          <li><code>.keyswitch</code>(Studio One)</li>
        </ul>
        <h4>共通設定:</h4>
        <p id="octave-offset"><strong>オクターブオフセット:</strong><br>
          エクスポート時に表示されるダイアログで、<code>オクターブオフセット</code>
          （初期値: 0）を設定できます。
        </p>
        <img src="img/octave-offset.png" alt="octave-offset">
        <ul>
          <li>音源側の<code>Middle C</code>と<code>DAW</code>側の
            <code>Middle C</code>の設定が異なる場合に、この値で補正します。
          </li>
          <li>
            <code>DAW</code>上で意図したキースイッチが反応しない場合は、
            この値を<code>±</code>して再度エクスポート・読み込みを試してください。
          </li>
          <li>
            補正後のMIDIノートナンバーが<code>0～127</code>の範囲を超えるような値には 設定できません。
          </li>
        </ul>
        <h4>DAW固有の設定</h4><!---------------------------------------------------------------------------------->
        <dl>
          <dt><strong>Cubase (.expressionmap)</strong></dt>
          <dd>
            <p>エクスポートダイアログで「リモートキー設定」を選択できます。</p>
            <ul>
              <li>
                <strong>リモートキー無し:</strong><br>
                MIDIキーボードからの入力にアーティキュレーションを割り当てません。
              </li>
              <li>
                <strong>出力マッピングと同じノート:</strong><br>
                MIDIキーボードからの入力に出力マッピングと同じMIDIノートを割り当てます。
              </li>
            </ul>
            <div class="alert">
              <strong>❗ カラー設定の注意（プリセットカラー推奨）:</strong><br>
              <div id="cubase-color" class="small">
                <p class="indent">
                  <code>Cubase</code>の<code>Expression Map</code>では、色はカラーコードではなく
                  「プリセット番号」で管理されています。そのため、任意のカラーコードを入力しても
                  <code>Cubase</code>上では正しく反映されません。
                </p>
                <ul>
                  <li>
                    本ツールのプリセットカラー（1～16）は、<code>Cubase</code>
                    のデフォルトカラー番号に対応しています。
                  </li>
                  <li>
                    プリセットと同じ色を入力した場合、対応する<code>Cubase</code>
                    のデフォルトのプリセットカラー番号として出力されます。
                  </li>
                  <li>
                    それ以外の色が入力されている場合は、デフォルトのカラー番号に自動補正されます。
                  </li>
                  <li>
                    <code>Cubase</code>用に作成する場合は、
                    <strong>プリセットカラーから選択して入力すること</strong>を推奨します。
                  </li>
                </ul>
              </div>
            </div>
          </dd>
          <dt><strong>Studio One (.keyswitch)</strong></dt>
          <dd>
            <p>エクスポートダイアログで「入力設定」を選択できます。</p>
            <ul>
              <li>
                <strong>入力と出力のMIDIノートを合わせる:</strong><br>
                MIDIキーボードからの入力及びピアノロールの入力を出力するMIDIノートに合わせます。
              </li>
              <li>
                <strong>入力設定なし出力のみ:</strong><br>
                サウンドバリエーションがMIDIノートを出力するのみに設定します。
              </li>
            </ul>
          </dd>
        </dl>

        <h3 id="menu-tools">🛠️ Appツール</h3><!--  ***********************************************************  -->
        <p>入力作業を効率化するための補助機能です。</p>
        <ul>
          <li>
            <strong>🎚️　サイドバーを開く:</strong><br><!------------------------------------------------------------>
            画面右側に編集用のサイドバーを表示します。<br>
            サイドバーの詳細は<sup>※</sup><a href="#sidebar">サイドバー機能</a>を参照してください。
          </li>
          <li><strong>Mainシート</strong><!------------------------------------------------------------------------>
            <ul>
              <li>
                <strong>🔃⇊🎹　MIDIノート順にソート( 降順 / 昇順 ):</strong><br>
                MIDIノート番号順に<code>Main</code>シート全体を並べ替えます。
              </li>
              <li>
                <strong>🔃∵🏷️　グループ定義順にソート:</strong><br>
                <code>Groups</code>シートのグループリストの定義順に<code>Main</code>シート全体を並べ替えます。
              </li>
              <li>
                <strong>🧩⇈🎹　半音階で範囲を埋める( 高音側へ / 低音側へ ):</strong><br>
                選択開始セル（太い青枠）のMIDIノートを基準に、選択した範囲に対して
                半音階の連番MIDIノートでセルを埋めます。<br>
                MIDIノート用のオートフィルのような機能です。<br>
                <p class="alert note">
                  ※選択開始セルから上に向かって選択していても基準セルは選択開始セルとなります。<br>
                  よって、基準セルがヘッダ行だった場合や、基準セルに有効なMIDIノートが入力されていなかった
                  場合などはエラーとなり処理が実行されません。
                </p>
              </li>
            </ul>
            <img src="img/fill-midi-note.png" alt="fill-midi-note">
          </li>
          <li><strong>Settingsシート</strong><!-------------------------------------------------------------------->
            <ul>
              <li>
                <strong>🎹→🗺️　マッピングを表示:</strong><br>
                <code>Settings</code>シートの<sup>※</sup>
                <a href="#mapping-viewer">Mapping Viewer</a>を更新します。
              </li>
              <li>
                <strong>🗺️→🧹　マッピングをクリア:</strong><br>
                <code>Mapping Viewer</code>の表示を消去します。
              </li>
            </ul>
          </li>
        </ul>

        <h3 id="menu-help">❓ Appヘルプ</h3><!--  *************************************************************  -->
        <p>ヘルプやトラブルシューティングに関する機能です。</p>
        <ul>
          <li>
            <strong>📝　ヘッダーヘルプの表示切替:</strong><br>
            ヘッダー行に表示されるヘルプメモの表示 / 非表示を切り替えます。
            <img src="img/header-help.png" alt="header-help">
          </li>
          <li>
            <strong>🌐　ヘルプセンターを表示:</strong><br>
            各種サポートリソースへアクセスするためのダイアログを表示します。<br>
            以下のリンクボタンが表示されます。
            <ul>
              <li>
                <strong>📖 オンラインマニュアル:</strong><br>
                このオンラインマニュアルへのリンクです。
              </li>
              <li>
                <strong>📺 YouTube 解説動画:</strong><br>
                解説動画へのリンクです。こちらのマニュアルからも視聴できます。
                <div id="video-container">
                  詳しい使い方などはこちらで解説する予定です。ただいま準備中です。
                </div><hr>
              </li>
              <li>
                <strong>💎 キースイッチ抽出 Gem</strong><br>
                シートの入力作業に便利な<code>Gemini Gem</code>を作りました。ぜひご活用ください。<br>
                <code>Gemini Gem</code>の詳細は<sup>※</sup><a href="#gemini-gem">キースイッチ抽出 Gem</a>
                を参照してください。
              </li>
            </ul>
          </li>
          <li><strong>トラブルシューティング</strong>
            <ul>
              <li>
                <strong>🔧🏷️ グループ入力規則の修復:</strong><br>
                <code>Main</code>シートの<code>Group Name</code>列のドロップダウンリスト
                が消えてしまったり、選択肢が表示されなくなった場合に実行してください。
                入力規則を再設定して修復します。
              </li>
            </ul>
          </li>
        </ul>
      </section>
      <!-- #endregion -->

      <!-- #region Sidebar -->
      <section id="sidebar"><!--  ****************************************************************************  -->
        <h2>サイドバー機能</h2>
        <p>メニューの「🛠️ Appツール」&gt;「🎚️　サイドバーを開く」から
          表示されるサイドバーでは、
          色やグループの管理・適用を直感的に行えます。</p>

        <h3 id="sidebar-color">🎨 カラー選択</h3><!--  *******************************************************  -->
        <p>プリセットカラーやカラーピッカーから色を選択できます。</p>
        <div class="tall-crop">
          <img src="img/sidebar.png" alt="sidebar" class="zoomable">
        </div>
        <ul>
          <li>
            <strong>プリセットカラー (16色):</strong><br>
            <code>Cubase</code>のデフォルトカラーに対応したパレットです。
            <code>Cubase</code>向けのエクスポートを行う場合は、この中から選択することを強く推奨します。
          </li>
          <li>
            <strong>カラーピッカー:</strong><br>
            自由に色を設定できます。クリップボードにコピーすることもできます。<br>
            <span class="very-small">
              ※<code>Cubase</code>では正しく反映されず、デフォルトの色に置き換わる場合があります。
            </span>
          </li>
        </ul>
        <p>選択した色は、下部のアクションボタンを使ってシートに適用します。</p>

        <h3 id="sidebar-group">🏷️ グループ選択</h3><!--  ******************************************************  -->
        <p>
          <code>Groups</code>シートで定義されたグループをプルダウンから選択します。
          <code>Groups</code>シートを編集した場合は、更新ボタン「<span class="skyblue">↻</span>
          グループリストを再読み込み」を押してリストを更新してください。
        </p>
        <img src="img/group-select.png" alt="group-select">

        <h3 id="sidebar-action">✔️ アクション (Mainシート)</h3><!--  ******************************************  -->
        選択中の色やグループを<code>Main</code>シートに適用するボタン群です。<br>
        <div class="quote-style">
          <div class="float-image">
            <img src="img/selected-range.png" alt="selected-range" class="zoomable" width="400">
          </div>
          <p class="indent note small">💡 Tips<br>
            選択範囲は連続していなくても問題ありません。
            また、行全体やターゲットでは無い列を選択してもターゲットの列に実行されます。
          </p>
          <div class="clear"></div>
        </div>
        <ul>
          <li>
            <strong>🎨→🔲　色を選択範囲に適用:</strong><br>
            <code>Main</code>シートで選択している行の<code>Color</code>列のセルに対して、
            現在選択中の「カラー」を適用します。
          </li>
          <li>
            <strong>🏷️→🔲　グループを選択範囲に適用:</strong><br>
            <code>Main</code>シートで選択している行の<code>Group Name</code>列に対して、
            現在選択中の「グループ」を適用します。
          </li>
          <li>
            <strong>🎨→🏷️　色を指定グループに適用:</strong><br>
            <code>Main</code>シート内の、現在選択中の「グループ」が設定されている全ての行の
            <code>Color</code>列のセルに対して、
            現在選択中の「カラー」を一括適用します。
          </li>
        </ul>
      </section>
      <!-- #endregion -->

      <!-- #region Gemini Gem -->
      <section id="gemini-gem"><!--  *************************************************************************  -->
        <h2>キースイッチ抽出 Gem</h2>
        <p>
          <code>Main</code>シートへの入力作業を補助するために作成された
          <code>Google Gemini</code>用のカスタム<code>Gem</code>です。
        </p>
        <div class="tall-crop">
          <img src="img/gemini.png" alt="gemini" class="zoomable">
        </div>
        <ol>
          <li>
            <strong>抽出機能:</strong><br>
            音源のマニュアルなどからテキスト、PDF、スクリーンショットなどをアップロードします。<br>
            <strong>アーティキュレーション名</strong>と<strong>MIDIノート名</strong>が抽出されます。<br>
            過不足や誤りが無いかを確認してください。
          </li>
          <li>
            <strong>データ整形:</strong><br>
            簡単な質問に答えます。翻訳したり、短縮形にしたりといった注文も行えます。<br>
          </li>
          <li>
            <strong>データ出力:</strong><br>
            抽出したデータは、<code>Main</code>シートへの貼り付けに適したヘッダ行無しの表形式で表示されます。<br>
            そのまま表の右下にある<sup>※</sup>「表をコピー」ボタンを押してコピーするか
            <code>TSV</code>や<code>CSV</code>などの形式にすることもできます。
            <span class="very-small">(※Googleスプレッドシートにエクスポートのボタンではありません)</span>
          </li>
        </ol>
        <div class="alert">
          <strong>❗ AI生成に関する注意:</strong><br>
          <p class="indent small">
            <code>Gemini</code>は非常に高い精度で文字を認識しますが、
            誤読やハルシネーションが発生する可能性があります。<br>
            抽出されたデータは元のマニュアルと照らし合わせて確認を行ってください。
          </p>
        </div>
        <div class="right">
          こちらからもアクセスできます。
          <a href="https://gemini.google.com/gem/10KXJeQ0_FxsTAfYv99VfV0LSSe6h5yj3?usp=sharing"
            target="_blank" rel="noopener noreferrer" class="gem-btn js-gem-link">
            💎 キースイッチ抽出 Gem を開く
          </a>
        </div>
      </section>
      <!-- #endregion -->

      <!-- #region Tips -->
      <section id="tips"><!--  *******************************************************************************  -->
        <h2>Tips</h2>
        <div class="accordion">
          <strong class="accordion-header">
            基本的な作業フロー ( <span class="skyblue">クリックして開閉</span> )
          </strong>
          <div class="accordion-content">
            基本的な作業フローは以下のようになっています。<br>
            <span class="indent very-small">※この手順でなくても問題はありません。</span><br><br>
            <ol>
              <li>
                <strong>準備 :</strong><br>
                  シートへの入力は手動入力の外にコピー＆ペーストでも入力できます。<br>
                  <sup>※</sup><a href="#gemini-gem">キースイッチ抽出 Gem</a>を使うと効率的です。<br>
              </li>
              <li>
                <strong>アーティキュレーション名とMIDIノート名の入力:</strong><br>
                <code>Main</code>シートの<code>Articuration Name</code>列、<code>MIDI Note</code>列
                にキースイッチ情報を入力します。<br>
                <code>Gemini</code>でコピーしたデータを貼り付ける場合は入力開始セル( 通常はA2セル )
                に貼り付けるだけで自動的にセルに分割されてデータが挿入されます。<br>
                <div class="quote-style">
                  <div class="float-image">
                    <img src="img/split-text.png"alt="split-text" class="zoomable" width="250">
                  </div>
                  <p class="note small">
                    💡 「表のコピー」からの貼り付けでは無く<code>CSV</code>データなどを貼り付けた場合には
                    自動的にセルに分割されない場合があります。<br>
                    その場合は貼り付けを行った際に出現するアイコンのプルダウンメニューから
                    「テキストを列に分割」を選択するとうまくいく場合があります。
                  </p>
                  <div class="clear"></div>
                </div>
                <code>MIDI Note</code>列にエラー判定が出た場合には修正します。<br>
                範囲外判定の場合には<code>Settings</code>シートの<code>Middle C</code>
                の設定を見直してください。<br>
                <code>Middle C</code>はデフォルトでは<code>4</code>に設定されています。
              </li>
              <li>
                <strong>グループ設定:</strong><br>
                <code>Groups</code>シートの<code>Group List</code>列にグループを追加して行きます。<br>
                その後<code>Main</code>シートの<code>Group Name</code>列でプルダウン選択して設定します。<br>
                グループ分けの必要が無い場合や<code>Studio One</code>形式でエクスポートする場合は
                スキップしても特に問題はありません。
              </li>
              <li>
                <strong>カラー設定:</strong><br>
                サイドバーなどを利用してカラーコードを入力します。<br>
                こちらも必要が無ければスキップしても特に問題はありません。
              </li>
              <li>
                <strong>マップ名設定:</strong><br>
                任意の名前を設定します。デフォルトでは<code>MyMap</code>となっていますが、
                識別するためにも分かり易い名前を設定する事をお勧めします。
              </li>
              <li>
                <strong>プロジェクトを保存:</strong><br>
                必須ではありませんが、編集中の作業を再開したりエクスポートした後で変更したい時などに
                便利なので保存しておく事をお勧めします。
              </li>
              <li>
                <strong>エクスポート:</strong><br>
                形式を選択してエクスポートしてください。<br>
                <code>MIDI Note</code>にエラーが無ければエクスポートできます。
                必要があれば<sup>※</sup><a href="#octave-offset">オクターブオフセット</a>を設定してください。
              </li>
              <li>
                <strong>DAWにインポート:</strong><br>
                お使いの<code>DAW</code>が指定するディレクトリに保存するなどしてインポートしてください。
              </li>
            </ol>
          </div>
        </div><hr>
        <div id="middle-C" class="quote-style">
          <strong>💡 Middle C =「中央のド」とは：</strong>
          <p class="indent">MIDIノートの基準となる音程の事です。</p>
          <ul>
            <li><strong><code>Middle C</code>のMIDIノートナンバー:</strong><br>
              MIDIノートは<code>0～127</code>の計128個の値を取ります。<br>
              MIDIノートナンバー<code>60</code>
              が<code>Middle C</code>= 中央のドです。
            </li>
            <li><strong>定義の違い:</strong><br>
              このMIDIノートナンバー<code>60</code>の<code>Middle C</code>を
              <code>YAMAHA</code>式では<code>C3</code>、<code>国際式</code>（Rolandなど）では
              <code>C4</code>と定義しています。他にも派閥があります。
            </li>
            <li><strong>音源による違い:</strong><br>
              採用している<code>Middle C</code>の定義が音源メーカーや<code>DAW</code>
              によってまちまちなので入力した音と出力される音でオクターブのズレが生じます。<br>
              マニュアルに記載されたMIDIノートを入力しているにもかかわらず、キースイッチのMIDIノートが
              意図した反応をしない時はこれが原因である可能性があります。
            </li>
          </ul>
        </div>
        <p>
          <strong>本アプリでの設定：</strong><br>
          <code>Settings</code>シートの<code>Middle C</code>で、使用する
          <strong>音源側の仕様に合わせて</strong><code>3, 4, 5</code>から値を選択してください。<br>
          もし<code>Main</code>シートで「範囲外」の判定が出た場合は、この
          <code>Middle C</code>の設定が音源と合っていない可能性があります。
          設定を変更して値が正常範囲（黒色）になるか確認してください。<br>
        </p>
        <p>
          音源側と<code>DAW</code>側の採用している<code>Middle C</code>が合わない場合はエクスポート時に
          <sup>※</sup><a href="#octave-offset">オクターブオフセット</a>を設定することによって対応してください。<br>
          <span class="very-small">
            ※<code>DAW</code>側でこの差分を吸収する設定ができる機能が搭載されている物もあります。
          </span>
        </p>
        <h3>推奨ブラウザ・環境</h3><!-- ************************************************************************  -->
        <p>
          PC版のブラウザであれば特に問題ないと思われます。<br>ただし、
          <strong>スマートフォンやタブレットのアプリ版スプレッドシートでは GAS（スクリプト）
          が実行できないため、本ツールは使用できません。</strong>必ずPC環境でご利用ください。
        </p>
      </section>
      <!-- #endregion -->

      <!-- #region Changelog -->
      <section id="changelog"><!--  ***************************************************************************  -->
        <h2>更新履歴</h2>
        <dl id="changelog-list"></dl>
      </section>
      <!-- #endregion -->

      <!-- #region Legal -->
      <section id="legal"><!--  *******************************************************************************  -->
        <h2>免責事項・ライセンス</h2>
        <h3>免責事項</h3>
        <p>
          本ツールの使用によって生じた、いかなる損害（データの消失、破損、業務の停止、PC環境の不具合など）
          についても作者は一切の責任を負いません。自己責任でご利用ください。
        </p>
        <h3>ライセンス</h3>
        <p>本ツールのライセンスは <strong>MIT License</strong> に準拠します。
        商用・非商用を問わず、誰でも無償で自由に使用、複製、変更、再配布することができます。
        </p>
      </section>
      <!-- #endregion -->
    </main>
  </div>

  <footer><!--  ***********************************************************************************************  -->
    <p>&copy; 2025 Second Illness</p>
  </footer>

  <button id="back-to-top" title="トップへ戻る" aria-label="ページトップへ戻る">↑</button>

  <!-- 画像拡大用モーダル -->
  <div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="img01">
  </div>

  <!-- 更新履歴データの読み込み -->
  <script src="changelog.js"></script>
  <script>
    // トップへ戻るボタンの制御
    const backToTop = document.getElementById('back-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        backToTop.classList.add('visible');
      } else {
        backToTop.classList.remove('visible');
      }
    });
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // 更新履歴の生成
    const changelogList = document.getElementById('changelog-list');
    if (typeof changelogData !== 'undefined' && changelogList) {
      changelogData.forEach(item => {
        // dt要素 (日付とバージョン)
        const dt = document.createElement('dt');
        dt.textContent = `${item.date} (${item.version})`;

        // dd要素 (変更内容リスト)
        const dd = document.createElement('dd');
        const ul = document.createElement('ul');

        item.changes.forEach(change => {
          const li = document.createElement('li');
          li.textContent = change;
          ul.appendChild(li);
        });

        dd.appendChild(ul);
        changelogList.appendChild(dt);
        changelogList.appendChild(dd);
      });
    }

    // リンク設定(app_links.json)の読み込みと適用
    fetch('app_links.json')
      .then(response => response.json())
      .then(links => {
        // 1. Gemini Gemリンクの更新
        const gemLink = links.find(link => link.label.includes('Gem'));
        if (gemLink) {
          const gemBtns = document.querySelectorAll('.js-gem-link');
          gemBtns.forEach(btn => btn.href = gemLink.url);
        }

        // 2. 動画セクションの更新
        const videoLink = links.find(link => link.label.includes('YouTube'));
        const videoContainer = document.getElementById('video-container');
        if (videoLink && videoContainer) {
          videoContainer.innerHTML = ''; // 既存のプレースホルダーをクリア

          // URLから動画IDを抽出 (v=XXXX)
          let videoId = null;
          try {
            const urlObj = new URL(videoLink.url);
            videoId = urlObj.searchParams.get('v');
          } catch (e) {
            // URL解析失敗時はリンクとして扱う
          }

          if (videoId) {
            // 動画IDがある場合は埋め込みプレーヤーを表示
            const wrapper = document.createElement('div');
            wrapper.className = 'video-responsive';
            wrapper.innerHTML = `
              <iframe
                src="https://www.youtube.com/embed/${videoId}"
                title="${videoLink.label}"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
              </iframe>`;
            videoContainer.appendChild(wrapper);
          } else {
            // 動画IDがない場合は準備中メッセージを表示
            const p = document.createElement('p');
            p.textContent = '詳しい使い方などはこちらで解説する予定です。ただいま準備中です。';
            p.style.marginBottom = '0.5rem';
            videoContainer.appendChild(p);

            // URLが設定されている場合（チャンネルTOPなど）はリンクボタンを表示
            if (videoLink.url) {
              const a = document.createElement('a');
              a.href = videoLink.url;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.className = 'gem-btn'; // 既存のボタンスタイルを流用
              a.textContent = videoLink.label;
              a.style.display = 'inline-block';
              a.style.textDecoration = 'none';
              a.style.textAlign = 'center';
              videoContainer.appendChild(a);
            }
          }
        }
      })
      .catch(err => console.error('リンク設定の読み込みに失敗しました', err));

    // 画像モーダル制御
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("img01");
    const images = document.querySelectorAll('.zoomable');

    images.forEach(img => {
      // アイコン表示用のラッパーを自動生成（tall-crop以外）
      if (!img.parentElement.classList.contains('tall-crop')) {
        const wrapper = document.createElement('div');
        wrapper.className = 'zoom-container';
        img.parentNode.insertBefore(wrapper, img);
        wrapper.appendChild(img);
      }

      img.addEventListener('click', function() {
        modal.style.display = "block";
        modalImg.src = this.src;
      });
    });

    const closeSpan = document.querySelector(".close");
    if (closeSpan) closeSpan.onclick = () => modal.style.display = "none";

    modal.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

    // アコーディオン制御関数
    const setupAccordion = (accordion)  => {
      const header = accordion.querySelector('.accordion-header');
      const content = accordion.querySelector('.accordion-content');

      if (!header || !content) return;

      // 初期状態: is-openクラスがなければ隠しておく
      if (!accordion.classList.contains('is-open')) {
        content.style.display = 'none';
      }

      header.addEventListener('click', () => {
        if (content.style.display === 'none') {
          // 開く
          accordion.classList.add('is-open');
          content.style.display = 'block';
          content.animate(
            [{ height: '0px', opacity: 0 }, { height: content.scrollHeight + 'px', opacity: 1 }],
            { duration: 300, easing: 'ease-out' }
          );
        } else {
          // 閉じる
          accordion.classList.remove('is-open');
          // 閉じるアニメーション
          const closingAnim = content.animate(
            [{ height: content.scrollHeight + 'px', opacity: 1 }, { height: '0px', opacity: 0 }],
            { duration: 300, easing: 'ease-out' }
          );
          closingAnim.onfinish = () => {
            content.style.display = 'none';
          };
        }
      });
    }

    // クラス .accordion を持つ要素に適用
    document.querySelectorAll('.accordion').forEach(setupAccordion);
  </script>
</body>
</html>